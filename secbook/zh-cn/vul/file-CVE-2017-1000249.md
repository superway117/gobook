# 复盘: CVE-2017-1000249: file: stack based buffer overflow

file(1) versions 5.29, 5.30 and 5.31 contain a stack based
buffer overflow when parsing a specially crafted input file.

The issue lets an attacker overwrite a fixed 20 bytes stack buffer
with a specially crafted .notes section in an ELF binary file.

There are systems like amavisd-new that automatically run file(1)
on every email attachment. To prevent an automated exploit by email,
another layer of protection like -fstack-protector is needed.


## 准备环境

在ubuntu上安装cppcheck
```
apt install  cppcheck
```

下载有问题的代码

```
git clone https://github.com/file/file.git
cd file
git checkout FILE5_31
```

## 用cppcheck发现

```
cppcheck --enable=all ./src/readelf.c
```

这里enable all表示要执行所有类型的检测，如何不加`--enable=all`检测不出来问题。
```
--enable=<id>        Enable additional checks. The available ids are:
                          * all
                                  Enable all checks. It is recommended to only
                                  use --enable=all when the whole program is
                                  scanned, because this enables unusedFunction.
                          * warning
                                  Enable warning messages
                          * style
                                  Enable all coding style checks. All messages
                                  with the severities 'style', 'warning',
                                  'performance' and 'portability' are enabled.
                          * performance
                                  Enable performance messages
                          * portability
                                  Enable portability messages
                          * information
                                  Enable information messages
                          * unusedFunction
                                  Check for unused functions. It is recommended
                                  to only enable this when the whole program is
                                  scanned.
                          * missingInclude
                                  Warn if there are missing includes. For
                                  detailed information, use '--check-config'.
                         Several ids can be given if you separate them with
                         commas. See also --std

```
output
```
ck all configurations. [toomanyconfigs]

^
Checking readelf.c: ARCH_ELFSIZE;ELFSIZE...
Checking readelf.c: BUILTIN_ELF...
readelf.c:514:46: warning: Logical disjunction always evaluates to true: descsz >= 4 || descsz <= 20. [incorrectLogicOperator]
     type == NT_GNU_BUILD_ID && (descsz >= 4 || descsz <= 20)) {
                                             ^
readelf.c:1478:7: style: The scope of the variable 'ibuf' can be reduced. [variableScope]
 char ibuf[BUFSIZ];
      ^
readelf.c:1479:10: style: The scope of the variable 'bufsize' can be reduced. [variableScope]
 ssize_t bufsize;
         ^
readelf.c:1480:17: style: The scope of the variable 'align' can be reduced. [variableScope]
 size_t offset, align, len;
                ^
Checking readelf.c: BUILTIN_ELF;ELFCORE...
readelf.c:757:20: style: Same value in both branches of ternary operator. [duplicateValueTernary]
   for (i = 0; i < NOFFSETS; i++) {
                   ^
readelf.c:812:26: style: Same value in both branches of ternary operator. [duplicateValueTernary]
    for (k = i + 1 ; k < NOFFSETS; k++) {
                         ^
Checking readelf.c: BUILTIN_ELF;ELFCORE;USE_NT_PSINFO...
Checking readelf.c: BUILTIN_ELF;ELFCORE;notyet...
Checking readelf.c: BUILTIN_ELF;HAVE_UNISTD_H...
Checking readelf.c: BUILTIN_ELF;notyet...
Checking readelf.c: ELFCORE...
Checking readelf.c: HAVE_CONFIG_H...
Checking readelf.c: HAVE_FORK...
Checking readelf.c: HAVE_FREELOCALE;HAVE_NEWLOCALE;HAVE_USELOCALE...
readelf.c:1573:0: style: The function 'file_tryelf' is never used. [unusedFunction]

^
nofile:0:0: information: Cppcheck cannot find all the include files (use --check-config for details) [missingInclude]
```

这里关键的地方就是
```
readelf.c:514:46: warning: Logical disjunction always evaluates to true: descsz >= 4 || descsz <= 20. [incorrectLogicOperator]
     type == NT_GNU_BUILD_ID && (descsz >= 4 || descsz <= 20)) {
```
查看源码
[原始代码](https://github.com/file/file/blob/FILE5_31/src/readelf.c)
[修复代码](https://github.com/file/file/commit/9611f31313a93aa036389c5f3b15eea53510d4d1)

`descsz >= 4 `满足条件的情况下`descsz`可能会大于`20`, 从而导致line 535的`memcpy`写stack overflow.


## 用


## References

- [seclists issue report](https://seclists.org/oss-sec/2017/q3/397)
- [code commit  to  fix CVE-2017-1000249](https://github.com/file/file/commit/35c94dc6acc418f1ad7f6241a6680e5327495793#diff-a41f3f1e97e8ce9aa3ddfdbb04df0036cb74f478f3f03f3e1d942d26e6960e47L514)
- [tag FILE5_31 which has CVE-2017-1000249 issue](https://github.com/file/file/releases/tag/FILE5_31)
- [joern script to parse CVE-2017-1000249](https://github.com/elManto/StaticAnalysisQueries/blob/main/CVE-2017-1000249/query.ql)