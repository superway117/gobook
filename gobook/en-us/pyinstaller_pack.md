## pyinstaller Packages

### Developer example

**Applicable scenario description**
1. pyecharts need to be applied to standalone GUI software / CS architecture development
2. pyinstaller packaging to generate a single file executable (.exe)
3. rendering controls can support HTML5 related interactions and can properly support pyecharts basic interactive controls

**Current environment information, for reference only (system environment and pyecharts version)**

> pyecharts: 1.7.1
> PyInstaller: 4.0
> cefpython3: 66.0
> wxPython: 4.1.0
> Python: 3.7.2
> Platform: Windows-10-10.0.17763-SP0


**Process steps**
1. pyecharts resource files `datasets` and `templates` are integrated into a specific directory (e.g. `. /resources` folder)
![image](https://user-images.githubusercontent.com/37883510/91822530-8200cb00-ec6a-11ea-867f-58dcaf60a3cb.png)


2. This step is divided into two cases.
   ① There is already a `.spec` file generated by pyinstaller
   Modify the `datas` field (append or add)
    ```python
    
    a = Analysis(['main.py'],
             pathex=['. \\'],
             binaries=[],
             datas=[('. \\resource\\\datasets', 'pyecharts\\\\datasets\\\\.') , 
                    ('. \\resource\\\templates', 'pyecharts\\\render\\\templates\\\.')] ,
             hiddenimports=[],
             hookspath=[],
             runtime_hooks=[],
             excludes=[],
             win_no_prefer_redirects=False,
             win_private_assemblies=False,
             cipher=block_cipher,
             noarchive=False)
    ```
   The left element in the tuple is the resource file path, and the right is the location of the packaged copy relative to the temporary folder path.
   ② No `.spec` file
   The cmd/bat script pyinstaller adds the `-add-data` option.
   ```bat
   pyinstaller --add-data=". \resource\datasets;pyecharts\datasets\." --add-data=". \resource\templates;pyecharts\render\templates\." -Fw main.py
   ```
   Up to this point, the problem of missing resources related to pyecharts is initially solved. But we still need to keep working on our hard-drawn images if we want to display them further on the GUI!

3. cefpython3 calls `cef.Initialize(settings=XXX)` to configure the initialization content for the following adaptations.
   ```python
   # import os, sys, wx etc.
   ...
   settings = {X: XXX} # original setting dict()
   if getattr(sys, 'frozen', False):
   if wx.Platform == "__WXMSW__":
   settings.update(
   dict(resources_dir_path=sys._MEIPASS,
   locales_dir_path=os.path.join(sys._MEIPASS, 'locales'),
   browser_subprocess_path=os.path.join(sys._MEIPASS, 'subprocess.exe'),
   log_file=os.path.join(sys._MEIPASS, 'debug.log'))
   )
   cef.Initialize(settings=settings)
   ...
   ```
   This part of `__WXMSW__` is the platform identifier for wxPython, you can refer to [here](https://zhuanlan.zhihu.com/p/141467076) to adapt the same for other platforms.

4. Write the `hook-cefpython3.py` file and add it to the `hookspath` attribute of the `.spec` file.

   You can refer to the [official documentation](https://github.com/cztomczak/cefpython/blob/master/examples/pyinstaller/hook-cefpython3.py) of cefpython3 to write the file here, but you need to modify the following fields.
    ```python
    ...
    from PyInstaller.utils.hooks import get_package_paths
    ...
    CEFPYTHON3_DIR = get_package_paths("cefpython3")[1]
    ...
    def get_cefpython3_datas():
        ...
        # SPECIAL ATTENTION of this dot '.' !!!
        ret.append((os.path.join(CEFPYTHON3_DIR, filename),
                    "."))
    ...
    ```
   Pay special attention to the dot in that append field, which is the temporary folder `sys._MEIPASS` referring to the path when run after packaging. The official sample document is directly empty characters `""`, anyway, that I am not directly run up ... : P

   Add the modified `hook-cefpython3.py` file. (I still put it lazily into `. /resources`)
   ①Configure the file with `.spec`
    ```python
    
    a = Analysis(
        ...
             hiddenimports=[],
             hookspath=['. \\resources\\\hooks'],
        ...)
    ```
   ② No `.spec` file
   The cmd/bat script pyinstaller adds the `-additional-hooks-dir` option.
    ```bat
    pyinstaller ... --additional-hooks-dir=". \resources\hooks" -Fw main.py
    ```
   Then just run the `.bat` script or create the pipenv environment install the library files knock the commands and so on to collect the dishes.

**Simple explanation**

All of the above mentioned configuration parts are actually caused by the change in the hierarchy and path correspondence of the original library files after pyinstaller is packaged and before it is packaged. (See the explanation of ``frozen'' in the pyinstaller official project)


**references**
[issue #1698](https://github.com/pyecharts/pyecharts/issues/1698)
[issue #1653](https://github.com/pyecharts/pyecharts/issues/1653)
[issue #1625](https://github.com/pyecharts/pyecharts/issues/1625)
[issue #960](https://github.com/pyecharts/pyecharts/issues/960)
[cefpython](https://github.com/cztomczak/cefpython/tree/master/examples/pyinstaller)
[pyinstaller](https://pyinstaller.readthedocs.io/en/stable/feature-notes.html?highlight=frozen#solution-in-pyinstaller)
